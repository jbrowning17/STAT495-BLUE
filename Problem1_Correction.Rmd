---
title: "BLUE group NHANES Report "
author: "Caleb Ki, Stephany Flores-Ramos, Jordan Browning"
date: "November 9, 2016"
output: 
  pdf_document:
    fig_height: 3
    fig_width: 5
  html_document:
    fig_height: 3
    fig_width: 5
  word_document:
    fig_height: 3
    fig_width: 5
---

```{r, setup, include=FALSE}
require(mdsr)   # Load additional packages here 
require(NHANES)
require(cowplot)
require(xtable)
# Some customization.  You can alter or delete as desired (if you know what you are doing).
trellis.par.set(theme=theme.mosaic()) # change default color scheme for lattice
knitr::opts_chunk$set(
  tidy=FALSE,     # display code as typed
  size="small")   # slightly smaller font for code
```

#### NHANES

Use the `NHANES` training dataset to fit and interpret a linear regression model of BMI (body mass index) as a function of being physically active, using alcohol, age, gender, and poverty status.  

Be sure to report RMSE for the training set and for the test set.


```{r}
set.seed(1994)
NHANES <- NHANES %>% mutate(alcoholavg = AlcoholDay * AlcoholYear / 365) %>% 
  mutate(alcoholavg = ifelse(is.na(alcoholavg), 0, alcoholavg)) %>%
  mutate(PhysActive = ifelse(PhysActive == "Yes", "Active", "Inactive"))
rows <- sample(1:nrow(NHANES), 8000)
train <- NHANES[rows,] %>% filter(Age >= 18)
test <- NHANES[-rows,] %>% filter(Age >= 18)
```

Your report should provide background on these data, describe the analytic sample, fit and interpret the model, and undertake model assessment.  You should include one figure that summarizes key findings.



SOLUTION:

##The dataset

The NHANES dataset is survey data from 2009-2012 gathered by the US National Center for Health Statistics (NCHS), who started collecting health and nutrition survey data in the 1960s. This data is a collection of survey data on health and nutrition topics along with vital health information collected via a health examination in one of NCH's mobile examination centers (MEC). Since the target population is "non-institutionalized civilian resident population of the United States", the sample is designed to oversample certain subpopulations. This is important to any analysis performed on the dataset as they could have huge implications on any conclusions drawn.

##Sample Description

To fit the model a random sample of 8000 was taken from the NHANES dataset, which will be called our training dataset. Because alcohol consumption was not recorded for those below 18, we have chosen to remove those below 18 years old. We couldn't just code these values to 0, since the fact that they were nto recorded does not necessarily mean that the amount of alcohol consumed for those below 18 was 0. After taking out all those below 18 for our training dataset, we are left with 5984 observations. 

The following is a list of variables that we are concerned with and a look at them in our training dataset:

```{r, echo=FALSE, fig.width=6, fig.height=4, fig.align='center'}
par(mfrow=c(2,3))
hist(train$BMI, xlab = "BMI", main = "Histogram of BMI", xlim = c(15, 50))
barplot(table(train$PhysActive)/5984, xlab = "Physically Active", ylab = "Proportion", main = "Proportion of \nPhysically Active")
hist(train$alcoholavg, xlab = "Alcohol Average", main = "Histogram of Alcohol Avg", xlim = c(0, 6))
hist(train$Age, xlab = "Age", main = "Histogram of Age")
barplot(table(train$Gender)/5984, xlab = "Gender", ylab = "Proportion", main = "Proportion of Gender")
hist(train$Poverty, xlab = "Poverty", main = "Histogram of Poverty")
```

`BMI` - Body mass index calculated by $\frac{weight}{height^2}$ in $\frac{kg}{m^2}$

The distribution of BMI is nearly normal, though it is slightly right-skewed. There are 53 missing data points for BMI. 


`PhysActive` - A dichotomous variable. Yes or no depending on the answer to the question, does the participant do moderate or vigorous-intensity sports?

There are slightly more physically active people in this sample than not, with 52% being physically active and 48% being not. There are no missing data points for physically active. 


`alcoholavg` - The average number of drinks consumed per day over the past year. This was found by multiplying the AlcoholDay variable which is the average number of drinks consumed on days that participant drank alcoholic beverages and the AlcoholYear variable which is the estimated number of days over the past year that participant drank alcoholic beverages then we divided by 365 to get the average. This was done because the original variables concerning alcohol were not a comprehensive in their description of alcoholic behavior. This new coded variable tries to account for both frequency and quantity of drinking. 

Nearly all have less than one drink per day. There are some high outliers with a max of 23 drinks per day on average during the year, so the distribution is right skewed. There are no missing data points for alcohol average.. 

`Age` - The age in years of the study participant at the time of the screening

The distribution of age is nearly uniform. There are no missing data points for age. 


`Gender` - Gender of participant coded as male or female

The number of males and females are roughly equal, with 49% of the sample being male and 51% being female. There are no missing data points for gender. 


`Poverty` - Ratio of family income to poverty guidelines. Kept the ratio instead of using an indicator variable. This way the model gets more information about their income rather than just that they are above/below the poverty line.

There sample is unimodal with the highest number of people having a family income about 5 times the poverty level. There are 467 missing data points here. 


##Our model
```{r}
mod <- lm(BMI ~ PhysActive + Age + Gender + Poverty + alcoholavg + Age*alcoholavg, data=train)
```

```{r, echo=FALSE}
summ_mod<-summary(mod)
```

```{r, echo=FALSE, results='asis', fig.height=6, fig.width=6, fig.align='center'}
xtable(summ_mod)
```

Accounting for all other factors, the estimated mean BMI of a population of females who are physically active is 27.91. Furthermore, we see that the mean BMI for a population who are physically inactive is 1.73 more than that of a physically active population. Then, if a person is male, we see that the mean BMI for this population is 0.31 higher as compare to the mean BMI of a female population. In addition, with each unit increase in the average number of drinks consumed per day over the past year average, the mean BMI increases by 0.04. Furthermore, this model tells us that the mean BMI of a population increases by 0.02 for each additional year in someone's age and this mean BMI actually decreases by 0.22 with each 1 unit increase in the ratio of family income to poverty guidelines. Finally, we see that the mean BMI decrease by 0.01 for each unit increase in age and alcohol average. 

Something else we can note from this model is that it also tells us that all of these factors are statistically significant at the 0.05 $\alpha$ level with the exception of `Gender`, `alcoholavg`, and the `Age`*`alcoholavg` interaction term.

##Model Assesment

###LINE

To check the appropriateness of our model we checked the following assumptions: 

*Linearity*
```{r, echo=FALSE}
age_p<-ggplot(data=train, aes(x=Age, y=BMI)) + geom_point() + stat_smooth(method=loess) + labs(x="Age (years)") + theme(axis.title=element_text(size=10),
        axis.text=element_text(size=7))
poverty_p<-ggplot(data=train, aes(x=Poverty, y=BMI)) + geom_point() + stat_smooth(method=loess) + labs(x="Poverty\n(ratio of family income)")+  theme(axis.title=element_text(size=10),
        axis.text=element_text(size=7))
alcoholavg_p<-ggplot(data=train, aes(x=alcoholavg, y=BMI)) + geom_point() + stat_smooth(method=loess) + labs(x="Average Alcohol\nConsumption\n(number of drinks\n/day/year)") + theme(axis.title=element_text(size=10),
        axis.text=element_text(size=7))
```

```{r, echo=FALSE, warning=FALSE, fig.align='center', fig.height=3, fig.width=5}
plot_grid(age_p, poverty_p, alcoholavg_p, ncol = 3, align = 'h')
```

The xy plot of BMI vs. Age and Poverty shows that there is a lot of noise in the data. This inhibits our ability to make a determination of lineary between these variables and BMI. The BMI vs. Average Alcohol Consumption also shows a lot of noise, but we also see that most of the data is accumulated to the left with a few outliers to the right showing high leverage. Linearity also does not seem to be met in this case.

*Normality*
```{r,fig.keep='last', fig.align='center', fig.width=5, fig.height=3}
qqmath(~residuals(mod))
ladd(panel.qqmathline(residuals(mod)))
```

Based on the qqplot above we can see that our model does not meet the normality assumption because we can see that both tails of the residual distribution are highly skewed. 

*Equal Variance*
```{r, echo=FALSE, fig.align='center', fig.width=5, fig.height=3}
ggplot(mod, aes(.fitted, .resid)) + 
  geom_point() + 
  geom_hline(yintercept = 0) +
  xlab("Fitted Values") +
  ylab("Residuals") +
  labs(title = "Residuals vs. Fitted Plot")
```

The constant variance condition of errors does not hold. As the fitted values become larger, the variance of the residuals become larger and larger. Also, the normality condition of the residuals does not hold either. Again as the fitted values increase, the residuals take on more and larger positive values. So the distribution of residuals skews right as the fitted values increase.

*Independence*

We are skeptical to assume independence in this case becuase all the subjects that took the NHANES survey volunteered to participate in the study. 

###Cross-Validation

In addition to checking the LINE assumptions, we also used a cross validation method to test the robustness of our model against a test set, a dataframe with the other observations from the `NHANES` dataset not included in the training set. 

```{r, tidy=TRUE}
test$predictVal <- predict(mod, test)
test2 <- test %>% filter(!is.na(predictVal)) %>% filter(!is.na(BMI)) %>% mutate(sqerror = (BMI-predictVal)^2)
train$predictVal <- predict(mod, train)
train2 <- train %>% filter(!is.na(predictVal)) %>% filter(!is.na(BMI)) %>% mutate(sqerror = (BMI-predictVal)^2)

mseTest <- sum(test2$sqerror)/nrow(test2)
rmseTest <- sqrt(mseTest) #rmse for test set
rmseTest

mseTrain <- sum(train2$sqerror)/nrow(train2)
rmseTrain <- sqrt(mseTrain) #rmse for training set
rmseTrain

mean(NHANES$BMI, na.rm = TRUE) #mean of BMI values
median(NHANES$BMI, na.rm = TRUE) # median of BMI values

rsquared <- 1 - sum(test2$sqerror)/sum((test2$BMI - mean(test2$BMI))^2)
```

The root mean squared error is 6.292 for the test set and 6.699 for the training set. This shows that the model performs similarly for both the data it was fitted for and the data it was tested against, although the rmse is slightly higher for the training set. While the performance is consistent across the two datasets, the rmse values are very high relative to the values that the BMI takes. The average value of BMI is around 26 which is only around 4 times as large as the rmse. Additionally, the $R^2$ value is 0.0535, which shows that only slightly more than 5% of the variability in BMI is captured by the model. Overall, these measures show that the model is not a great fit for the data and that the actual predictive value of the model is not very good. I looked at the scatterplots of the different predictors against BMI but there seems to be a lot of noise. There doesn't seem to be an obvious relationship, so I believe that not even a transformation would help.

##Visual Accounting for Noise

```{r, fig.height = 6, fig.width = 12}
ggplot(data=test2, aes(x=Age, y=BMI)) + 
  geom_point()  + aes(colour=Gender) + 
  facet_wrap(~PhysActive, ncol=2)  + stat_smooth(method=lm, size=3) + 
  theme(legend.position="top") + 
  labs(title="Age Vs BMI by Gender and Whether Physically Active") +
  theme(axis.text = element_text(size = 12))
```

The purpose of this plot is to demonstrate how noisy the variables actually are. An initial look at the graph seems to show that there is almost difference in BMI for different ages, for different genders, or for different levels of physical activity. However, as the model indicates, there is some slight differences. The lines in the graph show that those who are physically active seem to have a lower BMI than those who are not. And those who are very young seem to have generally on average seem to have a lower BMI. This plot confirms the findings from our model: while there may be differences in BMI based on the different predictors, the differences themselves are very very small, and it's difficult to perceive them as the data is very noisy. In this case, since the model is still able to capture around 5.3% of the variability in such a noisy dataset, it may not be as bad as the diagnosis above suggests.